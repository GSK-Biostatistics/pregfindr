<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="pregfindr">
<title>Data Extraction â€¢ pregfindr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Data Extraction">
<meta property="og:description" content="pregfindr">
<meta property="og:image" content="https://gsk-biostatistics.github.io/pregfindr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">pregfindr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/pregfindr.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/codelists.html">Codelists</a>
    <a class="dropdown-item" href="../articles/data_extraction.html">Data Extraction</a>
    <a class="dropdown-item" href="../articles/identifying_pregnancy_start_and_end_dates.html">Identifying Pregnancy Start and End Dates</a>
    <a class="dropdown-item" href="../articles/outcome_hierarchy.html">Outcome Hierarchy</a>
    <a class="dropdown-item" href="../articles/trimester_hierarchy.html">Trimester Hierarchy</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Data Extraction</h1>
            
      
      
      <div class="d-none name"><code>data_extraction.Rmd</code></div>
    </div>

    
    
<p>For the algorithm to work, you need to extract from your cut of
MarketScan (Commercial Claims or Medicaid) specific claims records
(marked by the codes stored in the codelists) for services between
specific dates on women within specific age boundaries. This is the
first step highlighted in the <a href="pregfindr.html">pregfindr
vignette</a>.</p>
<p>The result of this extraction should follow the following format:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="fu">pregfindr</span><span class="fu">::</span><span class="va"><a href="../reference/extraction_example.html">extraction_example</a></span></span></code></pre></div>
<p>Since different companies use different technologies to store the
latest cut of MarketScan, we are sharing an example script that you can
customise for your data storage system. This script uses helper
functions defined in the package and specific codelists. To learn more
about the codelists and how to modify them, refer to the <a href="codelists.html">codelist vignette</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The script is designed to extract, process, and analyse healthcare data from the</span></span>
<span><span class="co"># MarketScan database. It identifies eligible women within a specific age range and study</span></span>
<span><span class="co"># period, retrieves their medical claims data, matches these with</span></span>
<span><span class="co"># pregnancy-related diagnosis and procedure codes, and combines all the data</span></span>
<span><span class="co"># into a single dataset. The script also includes logging and data saving</span></span>
<span><span class="co"># functionalities.</span></span>
<span></span>
<span><span class="co"># Loading packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gsk-biostatistics.github.io/pregfindr/">pregfindr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://logr.r-sassy.org" class="external-link">logr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Starting log -------------</span></span>
<span><span class="va">log_file</span> <span class="op">&lt;-</span> <span class="fu">log_open</span><span class="op">(</span>show_notes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Setting variables ------------</span></span>
<span><span class="fu">sep</span><span class="op">(</span><span class="st">"Variables"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pointer to latest cut of MarketScan available and key parameters for analysis</span></span>
<span><span class="va">cut</span> <span class="op">&lt;-</span> <span class="st">"2023q2"</span></span>
<span></span>
<span><span class="co"># Set Study Time Period - time frame of analysis</span></span>
<span><span class="va">study_start_date</span> <span class="op">&lt;-</span> <span class="st">"01Jan2021"</span> <span class="co"># study start date</span></span>
<span><span class="va">service_start_date</span> <span class="op">&lt;-</span> <span class="st">"2021-01-01"</span></span>
<span></span>
<span><span class="co"># when pregnancy ends outside of range, it will have unknown outcome</span></span>
<span><span class="va">study_end_date</span> <span class="op">&lt;-</span> <span class="st">"31Dec2021"</span> <span class="co"># study end date</span></span>
<span><span class="va">service_end_date</span> <span class="op">&lt;-</span> <span class="st">"2021-12-31"</span></span>
<span><span class="va">start_yr</span> <span class="op">&lt;-</span> <span class="fl">2021</span> <span class="co"># Study start year</span></span>
<span><span class="va">last_yr</span> <span class="op">&lt;-</span> <span class="fl">2021</span> <span class="co"># Study end year</span></span>
<span></span>
<span><span class="co"># pointer to key parameters for analysis - when drugs are approved for adult patients, then we might want to subset</span></span>
<span><span class="va">age_start</span> <span class="op">&lt;-</span> <span class="fl">30</span> <span class="co"># ages of interest</span></span>
<span><span class="va">age_end</span> <span class="op">&lt;-</span> <span class="fl">60</span> <span class="co"># ages of interest</span></span>
<span><span class="va">mem_days</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># minimum follow-up in a year - since want to find all who ever use meds</span></span>
<span><span class="co"># typically set to one day</span></span>
<span></span>
<span><span class="co"># Number of days before study start to assess pregnancy codes - full term pregnancies are 270 days - allows for longer pregnancies</span></span>
<span><span class="va">presvcstart</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span></span>
<span><span class="co"># Number of days for the pre-conception period - to allow for drugs to be flushed out</span></span>
<span><span class="va">pre_conception_days</span> <span class="op">&lt;-</span> <span class="fl">90</span></span>
<span></span>
<span><span class="co"># Number of DAYS of required enrolment before and after index  - to boost sensitivity</span></span>
<span><span class="va">enrolment</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co"># Log variables</span></span>
<span><span class="fu">put</span><span class="op">(</span><span class="fu"><a href="../reference/vars_content_to_string.html">vars_content_to_string</a></span><span class="op">(</span><span class="va">cut</span>, <span class="va">study_start_date</span>, <span class="va">study_end_date</span>, <span class="va">start_yr</span>, <span class="va">age_start</span>, <span class="va">age_end</span>, <span class="va">mem_days</span>, <span class="va">presvcstart</span>, <span class="va">pre_conception_days</span>, <span class="va">enrolment</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Store file locally (TRUE / FALSE)</span></span>
<span><span class="va">data_extraction_save_locally</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span></span>
<span><span class="co"># Connecting to database -------------</span></span>
<span></span>
<span><span class="co"># Setup connection to Impala - variables are present in environment</span></span>
<span></span>
<span><span class="va">db_connection</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span></span>
<span>  <span class="fu">odbc</span><span class="fu">::</span><span class="fu">odbc</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  driver <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"RDIP_IMPALA_DRIVER"</span><span class="op">)</span>,</span>
<span>  host <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"RDIP_IMPALA_SERVER"</span><span class="op">)</span>,</span>
<span>  port <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"RDIP_IMPALA_PORT"</span><span class="op">)</span>,</span>
<span>  authmech <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"RDIP_IMPALA_AUTH_MECH"</span><span class="op">)</span>,</span>
<span>  ssl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"RDIP_IMPALA_SSL"</span><span class="op">)</span>,</span>
<span>  trustedcerts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"RDIP_IMPALA_TRUSTED_CERTS"</span><span class="op">)</span>,</span>
<span>  database <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"RDIP_IMPALA_DATABASE"</span><span class="op">)</span>,</span>
<span>  uid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"RDIP_IMPALA_USERID"</span><span class="op">)</span>,</span>
<span>  pwd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"RDIP_IMPALA_PASSWORD"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show different schemas</span></span>
<span><span class="co">#dbGetQuery(db_connection, 'show schemas')</span></span>
<span></span>
<span><span class="co"># Create a lazy tbl from the Impala tables</span></span>
<span></span>
<span><span class="va">clnprw_marketscan_inpat</span> <span class="op">&lt;-</span> <span class="va">db_connection</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="fu">in_schema</span><span class="op">(</span><span class="st">"clnprw_truven_commercial_claims"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"t_s_inpat_"</span>, <span class="va">cut</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">clnprw_marketscan_outpat</span> <span class="op">&lt;-</span> <span class="va">db_connection</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="fu">in_schema</span><span class="op">(</span><span class="st">"clnprw_truven_commercial_claims"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"t_o_outpt_"</span>, <span class="va">cut</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save pregnancy codes (ICD-CM-9, ICD-CM.CM, and CPT) to database and import lazily</span></span>
<span><span class="va">icd9_diagnosis_pregnancy_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write_to_impala_then_read_lazy_table.html">write_to_impala_then_read_lazy_table</a></span><span class="op">(</span>tablename <span class="op">=</span> <span class="st">"icd9_dx_preg"</span>, <span class="fu">pregfindr</span><span class="fu">::</span><span class="va"><a href="../reference/icd9_diagnosis_pregnancy_codes.html">icd9_diagnosis_pregnancy_codes</a></span>,</span>
<span>                                                                       schema <span class="op">=</span> <span class="st">"clnprw_rwd"</span>, connection <span class="op">=</span> <span class="va">db_connection</span>, overwrite <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">icd10_diagnosis_pregnancy_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write_to_impala_then_read_lazy_table.html">write_to_impala_then_read_lazy_table</a></span><span class="op">(</span>tablename <span class="op">=</span> <span class="st">"icd10_dx_preg"</span>, <span class="fu">pregfindr</span><span class="fu">::</span><span class="va"><a href="../reference/icd10_diagnosis_pregnancy_codes.html">icd10_diagnosis_pregnancy_codes</a></span>,</span>
<span>                                                                        schema <span class="op">=</span> <span class="st">"clnprw_rwd"</span>, connection <span class="op">=</span> <span class="va">db_connection</span>, overwrite <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">icd9_procedure_pregnancy_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write_to_impala_then_read_lazy_table.html">write_to_impala_then_read_lazy_table</a></span><span class="op">(</span>tablename <span class="op">=</span> <span class="st">"icd9_proc_preg"</span>, <span class="fu">pregfindr</span><span class="fu">::</span><span class="va"><a href="../reference/icd9_procedure_pregnancy_codes.html">icd9_procedure_pregnancy_codes</a></span>,</span>
<span>                                                                       schema <span class="op">=</span> <span class="st">"clnprw_rwd"</span>, connection <span class="op">=</span> <span class="va">db_connection</span>, overwrite <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">icd10_procedure_pregnancy_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write_to_impala_then_read_lazy_table.html">write_to_impala_then_read_lazy_table</a></span><span class="op">(</span>tablename <span class="op">=</span> <span class="st">"icd10_proc_preg"</span>, <span class="fu">pregfindr</span><span class="fu">::</span><span class="va"><a href="../reference/icd10_procedure_pregnancy_codes.html">icd10_procedure_pregnancy_codes</a></span>,</span>
<span>                                                                        schema <span class="op">=</span> <span class="st">"clnprw_rwd"</span>, connection <span class="op">=</span> <span class="va">db_connection</span>, overwrite <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">cpt_pregnancy_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/write_to_impala_then_read_lazy_table.html">write_to_impala_then_read_lazy_table</a></span><span class="op">(</span>tablename <span class="op">=</span> <span class="st">"cpt_preg"</span>, <span class="fu">pregfindr</span><span class="fu">::</span><span class="va"><a href="../reference/cpt_pregnancy_codes.html">cpt_pregnancy_codes</a></span>,</span>
<span>                                                            schema <span class="op">=</span> <span class="st">"clnprw_rwd"</span>, connection <span class="op">=</span> <span class="va">db_connection</span>, overwrite <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Identify patients using Inpatient &amp; Outpatient claims -----------------</span></span>
<span><span class="co"># 1) We will identify all records for eligible women in the inpatient dataset, then retrieve all the procedures</span></span>
<span><span class="co"># they had by matching their procedures with several sets of codes</span></span>
<span><span class="co"># 2) We will repeat step 1 for the outpatient records</span></span>
<span><span class="co"># 3) We will merge all of these into a long list</span></span>
<span><span class="co"># 4) We will standardise age variables </span></span>
<span></span>
<span><span class="co"># Setting time variables</span></span>
<span><span class="co">## Start of study period minus a certain number of days to capture pregnancy start dates</span></span>
<span><span class="va">pre_service_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="va">service_start_date</span><span class="op">)</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="va">presvcstart</span><span class="op">)</span><span class="op">)</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span></span>
<span><span class="co">## End of study period</span></span>
<span><span class="va">service_end_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="va">service_end_date</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1) Inpatient claims</span></span>
<span></span>
<span><span class="co">## Identify all eligible women in inpatient database</span></span>
<span><span class="co">#' Note: if slow, pre-selecting vars in .data might speed it up</span></span>
<span></span>
<span><span class="va">inpatient_claims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_eligible_women.html">filter_eligible_women</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">clnprw_marketscan_inpat</span>,</span>
<span>  .age_start <span class="op">=</span> <span class="va">age_start</span>,</span>
<span>  .age_end <span class="op">=</span> <span class="va">age_end</span>,</span>
<span>  .last_yr <span class="op">=</span> <span class="va">last_yr</span>,</span>
<span>  .presvcdate <span class="op">=</span> <span class="va">pre_service_date</span>,</span>
<span>  .svcend <span class="op">=</span> <span class="va">service_end_date</span>,</span>
<span>  .claims_file <span class="op">=</span> <span class="st">"I"</span>,</span>
<span>  .variables_to_keep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">enrolid</span>, <span class="va">svcdate</span>, <span class="va">dobyr</span>, <span class="va">dx1</span>, <span class="va">dx2</span>, <span class="va">dx3</span>, <span class="va">dx4</span>, <span class="va">dxver</span>, <span class="va">pdx</span>, <span class="va">pproc</span>, <span class="va">proc1</span>, <span class="va">claims_file</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Inpatient ICD-9 Dx Codes</span></span>
<span><span class="va">icd9_pregnancy_diagnosis_inpatient_claims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_matches_in_ICD.html">find_matches_in_ICD</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">inpatient_claims</span>,</span>
<span>  inpat <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  .dxver <span class="op">=</span> <span class="st">"9"</span>,</span>
<span>  .icd_data <span class="op">=</span> <span class="va">icd9_diagnosis_pregnancy_codes</span>,</span>
<span>  .icd_value <span class="op">=</span> <span class="st">"icd9cm"</span>,</span>
<span>  .variables_to_keep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">enrolid</span>, <span class="va">dobyr</span>, <span class="va">dx</span>, <span class="va">description</span>, <span class="va">pdx</span>, <span class="va">claims_file</span>, <span class="va">svcdate</span>, <span class="va">final_trimester_code</span>, <span class="va">outcome</span>, <span class="va">secondary_outcome</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Inpatient ICD-10 Dx Codes</span></span>
<span><span class="va">icd10_pregnancy_diagnosis_inpatient_claims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_matches_in_ICD.html">find_matches_in_ICD</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">inpatient_claims</span>,</span>
<span>  inpat <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  .dxver <span class="op">=</span> <span class="st">"0"</span>,</span>
<span>  .icd_data <span class="op">=</span> <span class="va">icd10_diagnosis_pregnancy_codes</span>,</span>
<span>  .icd_value <span class="op">=</span> <span class="st">"icd10cm"</span>,</span>
<span>  .variables_to_keep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">enrolid</span>, <span class="va">dobyr</span>, <span class="va">dx</span>, <span class="va">description</span>, <span class="va">pdx</span>, <span class="va">claims_file</span>, <span class="va">svcdate</span>, <span class="va">final_trimester_code</span>, <span class="va">outcome</span>, <span class="va">secondary_outcome</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Inpatient ICD-9 Proc Codes</span></span>
<span><span class="va">icd9_pregnancy_procedure_inpatient_claims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_on_pregnancy_procedure_code.html">match_on_pregnancy_procedure_code</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">inpatient_claims</span>,</span>
<span>  .proc_data <span class="op">=</span> <span class="va">icd9_procedure_pregnancy_codes</span>,</span>
<span>  .by_var_claims <span class="op">=</span> <span class="st">"pproc"</span>,</span>
<span>  .by_var_proc_code <span class="op">=</span> <span class="st">"icd9_proc"</span>,</span>
<span>  .variables_to_keep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">enrolid</span>, <span class="va">dobyr</span>, <span class="va">proc</span>, <span class="va">description</span>, <span class="va">claims_file</span>, <span class="va">svcdate</span>, <span class="va">final_trimester_code</span>, <span class="va">outcome</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Inpatient ICD-10 Proc Codes</span></span>
<span><span class="va">icd10_pregnancy_procedure_inpatient_claims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_on_pregnancy_procedure_code.html">match_on_pregnancy_procedure_code</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">inpatient_claims</span>,</span>
<span>  .proc_data <span class="op">=</span> <span class="va">icd10_procedure_pregnancy_codes</span>,</span>
<span>  .by_var_claims <span class="op">=</span> <span class="st">"pproc"</span>,</span>
<span>  .by_var_proc_code <span class="op">=</span> <span class="st">"icd10_proc"</span>,</span>
<span>  .variables_to_keep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">enrolid</span>, <span class="va">dobyr</span>, <span class="va">proc</span>, <span class="va">description</span>, <span class="va">claims_file</span>, <span class="va">svcdate</span>, <span class="va">final_trimester_code</span>, <span class="va">outcome</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Inpatient CPT Codes</span></span>
<span><span class="va">cpt_pregnancy_inpatient_claims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_on_pregnancy_cpt_code.html">match_on_pregnancy_cpt_code</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">inpatient_claims</span>,</span>
<span>  .cpt_data <span class="op">=</span> <span class="va">cpt_pregnancy_codes</span>,</span>
<span>  .variables_to_keep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">enrolid</span>, <span class="va">dobyr</span>, <span class="va">cpt</span>, <span class="va">description</span>, <span class="va">claims_file</span>, <span class="va">svcdate</span>, <span class="va">final_trimester_code</span>, <span class="va">outcome</span>, <span class="va">secondary_outcome</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2) Outpatient claims</span></span>
<span></span>
<span><span class="co">## Identify all eligible women in outpatient dataset</span></span>
<span><span class="co"># ID women that fit inclusion criteria of age and time period</span></span>
<span><span class="va">outpatient_claims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_eligible_women.html">filter_eligible_women</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">clnprw_marketscan_outpat</span>,</span>
<span>  .variables_to_keep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">enrolid</span>, <span class="va">svcdate</span>, <span class="va">dobyr</span>, <span class="va">dx1</span>, <span class="va">dx2</span>, <span class="va">dx3</span>, <span class="va">dx4</span>, <span class="va">dxver</span>, <span class="va">proc1</span>, <span class="va">claims_file</span><span class="op">)</span>,</span>
<span>  .age_start <span class="op">=</span> <span class="va">age_start</span>,</span>
<span>  .age_end <span class="op">=</span> <span class="va">age_end</span>,</span>
<span>  .last_yr <span class="op">=</span> <span class="va">last_yr</span>,</span>
<span>  .presvcdate <span class="op">=</span> <span class="va">pre_service_date</span>,</span>
<span>  .svcend <span class="op">=</span> <span class="va">service_end_date</span>,</span>
<span>  .claims_file <span class="op">=</span> <span class="st">"O"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Outpatient ICD-9 Dx Codes</span></span>
<span><span class="va">icd9_pregnancy_diagnosis_outpatient_claims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_matches_in_ICD.html">find_matches_in_ICD</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">outpatient_claims</span>,</span>
<span>  inpat <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  .dxver <span class="op">=</span> <span class="st">"9"</span>,</span>
<span>  .icd_data <span class="op">=</span> <span class="va">icd9_diagnosis_pregnancy_codes</span>,</span>
<span>  .icd_value <span class="op">=</span> <span class="st">"icd9cm"</span>,</span>
<span>  .variables_to_keep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">enrolid</span>, <span class="va">dobyr</span>, <span class="va">dx</span>, <span class="va">description</span>, <span class="va">pdx</span>, <span class="va">claims_file</span>, <span class="va">svcdate</span>, <span class="va">final_trimester_code</span>, <span class="va">outcome</span>, <span class="va">secondary_outcome</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Outpatient ICD-10 Dx Codes</span></span>
<span><span class="va">icd10_pregnancy_diagnosis_outpatient_claims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_matches_in_ICD.html">find_matches_in_ICD</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">outpatient_claims</span>,</span>
<span>  inpat <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  .dxver <span class="op">=</span> <span class="st">"0"</span>,</span>
<span>  .icd_data <span class="op">=</span> <span class="va">icd10_diagnosis_pregnancy_codes</span>,</span>
<span>  .icd_value <span class="op">=</span> <span class="st">"icd10cm"</span>,</span>
<span>  .variables_to_keep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">enrolid</span>, <span class="va">dobyr</span>, <span class="va">dx</span>, <span class="va">description</span>, <span class="va">pdx</span>, <span class="va">claims_file</span>, <span class="va">svcdate</span>, <span class="va">final_trimester_code</span>, <span class="va">outcome</span>, <span class="va">secondary_outcome</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Outpatient CPT Codes</span></span>
<span><span class="va">cpt_pregnancy_outpatient_claims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_on_pregnancy_cpt_code.html">match_on_pregnancy_cpt_code</a></span><span class="op">(</span></span>
<span>  .data <span class="op">=</span> <span class="va">outpatient_claims</span>,</span>
<span>  .cpt_data <span class="op">=</span> <span class="va">cpt_pregnancy_codes</span>,</span>
<span>  .variables_to_keep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">enrolid</span>, <span class="va">dobyr</span>, <span class="va">cpt</span>, <span class="va">description</span>, <span class="va">claims_file</span>, <span class="va">svcdate</span>, <span class="va">final_trimester_code</span>, <span class="va">outcome</span>, <span class="va">secondary_outcome</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># 3) and 4) Bring datasets into work library to manipulate and clean</span></span>
<span></span>
<span><span class="co">## ICD-9/ICD-10: Combine inpatient and outpatient ICD-CM-9 and ICD-CM-10 diagnosis cohorts</span></span>
<span><span class="fu">sep</span><span class="op">(</span><span class="st">"Combine inpatient and outpatient ICD-CM-9 diagnosis cohorts"</span><span class="op">)</span></span>
<span><span class="va">icd9_pregnancy_diagnoses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">union</a></span><span class="op">(</span></span>
<span>  <span class="va">icd9_pregnancy_diagnosis_inpatient_claims</span>,</span>
<span>  <span class="va">icd9_pregnancy_diagnosis_outpatient_claims</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">put</span><span class="op">(</span><span class="st">"Step completed successfully."</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">sep</span><span class="op">(</span><span class="st">"Combine inpatient and outpatient ICD-CM-10 diagnosis cohorts"</span><span class="op">)</span></span>
<span><span class="va">icd10_pregnancy_diagnoses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">union</a></span><span class="op">(</span></span>
<span>  <span class="va">icd10_pregnancy_diagnosis_inpatient_claims</span>,</span>
<span>  <span class="va">icd10_pregnancy_diagnosis_outpatient_claims</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">put</span><span class="op">(</span><span class="st">"Step completed successfully."</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">sep</span><span class="op">(</span><span class="st">"Combine inpatient and outpatient ICD-CM-9 and ICD-CM-10 diagnosis cohorts"</span><span class="op">)</span></span>
<span><span class="va">icd_pregnancy_diagnosis_union</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/setops.html" class="external-link">union_all</a></span><span class="op">(</span></span>
<span>    <span class="va">icd9_pregnancy_diagnoses</span>,</span>
<span>    <span class="va">icd10_pregnancy_diagnoses</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">put</span><span class="op">(</span><span class="st">"Step completed successfully."</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## PROC: Combine inpatient procedure datasets</span></span>
<span><span class="fu">sep</span><span class="op">(</span><span class="st">"Combine inpatient procedure cohorts"</span><span class="op">)</span></span>
<span><span class="va">icd_pregnancy_procedure_union</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">union</a></span><span class="op">(</span></span>
<span>  <span class="va">icd9_pregnancy_procedure_inpatient_claims</span>,</span>
<span>  <span class="va">icd10_pregnancy_procedure_inpatient_claims</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">put</span><span class="op">(</span><span class="st">"Step completed successfully."</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## CPT: Merge inpatient and outpatient CPT code cohorts</span></span>
<span><span class="fu">sep</span><span class="op">(</span><span class="st">"Combine inpatient and outpatient CPT code cohorts"</span><span class="op">)</span></span>
<span><span class="va">cpt_pregnancy_union</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">union</a></span><span class="op">(</span></span>
<span>    <span class="va">cpt_pregnancy_inpatient_claims</span>,</span>
<span>    <span class="va">cpt_pregnancy_outpatient_claims</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">put</span><span class="op">(</span><span class="st">"Step completed successfully."</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Combine ICD9/ICD10, PROC, and CPT into a single dataset and add new age variables</span></span>
<span><span class="fu">sep</span><span class="op">(</span><span class="st">"Merge all data into one data set"</span><span class="op">)</span></span>
<span><span class="va">patients</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="co">## ICD9/ICD10</span></span>
<span>    <span class="va">icd_pregnancy_diagnosis_union</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">dx</span><span class="op">)</span>,</span>
<span>    <span class="co">## PROC</span></span>
<span>    <span class="va">icd_pregnancy_procedure_union</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">proc</span><span class="op">)</span>,</span>
<span>    <span class="co">## CPT</span></span>
<span>    <span class="va">cpt_pregnancy_union</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">cpt</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/calculate_age_variables.html">calculate_age_variables</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">put</span><span class="op">(</span><span class="st">"Step completed successfully."</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">db_connection</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Saving results Locally -------</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">data_extraction_save_locally</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">sep</span><span class="op">(</span><span class="st">"Saving results locally"</span><span class="op">)</span></span>
<span>  <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html" class="external-link">write_parquet</a></span><span class="op">(</span><span class="va">patients</span>, <span class="st">"extraction_result.parquet"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="st">"extraction_result.parquet"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">put</span><span class="op">(</span><span class="st">"Step completed successfully."</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu">put</span><span class="op">(</span><span class="st">"Step failed."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Closing log -------------</span></span>
<span><span class="fu">log_close</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Garbage collection -------</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Federico Concas, Jaspreet Multani, GlaxoSmithKline Research &amp; Development Limited.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
